jobs:

# jobs for the Nouvola sample application

################################

# add pipeline job
# Run API tests on Nouvola cloud
  - name: test-api-nouvola-run-tests
    type: runSh
    steps:
      - IN: test-api-nouvola-api-params
      - TASK:
        - script:
          # Install JQ for parsing JSON response from Nouvola API
          - sudo apt-get update
          - sudo apt-get install jq
          # Get test_id from Nouvola
          - 'TEST_ID=$(curl -X POST -H Content-Type:application/json -H "x-api:$NOUVOLA_API_KEY" https://divecloud.nouvola.com/api/v1/plans/$NOUVOLA_PLAN_ID/run --silent | jq -r ".test_id")'
          # Poll test run
          - echo $TEST_ID
          - TEST_STATUS=""
          - >
              while [[ "$TEST_STATUS" != "Emailed" ]]; do
                  TEST_STATUS=$(curl -X GET -H "Content-Type:application/json" -H "x-api:$NOUVOLA_API_KEY" https://divecloud.nouvola.com/api/v1/test_instances/$TEST_ID --silent | jq -r ".status")
                  echo "Status of the test run is "$TEST_STATUS
                  echo "Waiting for 10 seconds"
                  sleep 10
              done
    flags:
      - test-api-nouvola
